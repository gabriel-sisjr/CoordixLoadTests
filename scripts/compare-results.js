#!/usr/bin/env node

/**
 * Script to compare load test results
 * 
 * Analyzes JSON files generated by k6 and creates a comparison table
 * 
 * Usage:
 *   node scripts/compare-results.js [--scenario=<scenario>]
 */

const fs = require('fs');
const path = require('path');
const { parseK6Results } = require('./parse-k6-efficient');

const RESULTS_DIR = path.join(__dirname, '..', 'results');
const TARGETS = ['coordix', 'mediatR', 'wolverine'];
const SCENARIOS = ['smoke', 'rampup', 'load-steady', 'spike', 'stress', 'overnight'];

function extractMetrics(metrics) {
  if (!metrics) return null;

  const httpReqDuration = metrics['http_req_duration'];
  const httpReqs = metrics['http_reqs'];
  const httpReqFailed = metrics['http_req_failed'];

  const totalRequests = httpReqs?.values?.count || 0;
  const errors = httpReqFailed?.values?.count || 0;
  const errorRate = totalRequests > 0 ? (errors / totalRequests) : 0;

  return {
    // Percentiles
    p50: httpReqDuration?.values?.p50 || 0,
    p75: httpReqDuration?.values?.p75 || 0,
    p90: httpReqDuration?.values?.p90 || 0,
    p95: httpReqDuration?.values?.p95 || 0,
    p99: httpReqDuration?.values?.p99 || 0,
    p99_9: httpReqDuration?.values?.p99_9 || 0,
    // Basic statistics
    min: httpReqDuration?.values?.min || 0,
    max: httpReqDuration?.values?.max || 0,
    avg: httpReqDuration?.values?.avg || 0,
    med: httpReqDuration?.values?.med || 0,
    // Request metrics
    totalRequests: totalRequests,
    rps: httpReqs?.values?.rate || 0,
    errorRate: errorRate,
    errors: errors,
  };
}

async function findLatestResults(scenario) {
  const files = fs.readdirSync(RESULTS_DIR)
    .filter(file => file.startsWith(`${scenario}_`) && file.endsWith('.json'));

  const results = {};

  for (const target of TARGETS) {
    const targetFiles = files.filter(file => file.includes(`_${target}_`));
    if (targetFiles.length === 0) continue;

    // Get the latest one
    const latestFile = targetFiles.sort().reverse()[0];
    const filePath = path.join(RESULTS_DIR, latestFile);
    
    try {
      const metrics = await parseK6Results(filePath);
      const extracted = extractMetrics(metrics);

      if (extracted) {
        results[target] = {
          ...extracted,
          file: latestFile,
        };
      }
    } catch (error) {
      console.error(`‚ö†Ô∏è  Error processing ${latestFile}: ${error.message}`);
    }
  }

  return results;
}

function formatNumber(num, decimals = 2) {
  if (num === null || num === undefined) return 'N/A';
  return typeof num === 'number' ? num.toFixed(decimals) : num;
}

function formatDuration(ms) {
  if (ms === null || ms === undefined) return 'N/A';
  if (ms < 1) return `${(ms * 1000).toFixed(0)}¬µs`;
  if (ms < 1000) return `${ms.toFixed(2)}ms`;
  return `${(ms / 1000).toFixed(2)}s`;
}

function printComparisonTable(scenario, results) {
  console.log(`\n${'='.repeat(100)}`);
  console.log(`üìä COMPARISON: ${scenario.toUpperCase()}`);
  console.log(`${'='.repeat(100)}\n`);

  if (Object.keys(results).length === 0) {
    console.log('‚ùå No results found for this scenario\n');
    return;
  }

  // Table 1: Percentiles and Basic Stats
  console.log('‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');
  console.log('‚îÇ Target      ‚îÇ p50      ‚îÇ p75      ‚îÇ p90      ‚îÇ p95      ‚îÇ p99      ‚îÇ p99.9    ‚îÇ Avg      ‚îÇ');
  console.log('‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§');

  for (const target of TARGETS) {
    const data = results[target];
    if (!data) {
      console.log(`‚îÇ ${target.padEnd(11)} ‚îÇ N/A      ‚îÇ N/A      ‚îÇ N/A      ‚îÇ N/A      ‚îÇ N/A      ‚îÇ N/A      ‚îÇ N/A      ‚îÇ`);
      continue;
    }

    const p50 = formatDuration(data.p50);
    const p75 = formatDuration(data.p75);
    const p90 = formatDuration(data.p90);
    const p95 = formatDuration(data.p95);
    const p99 = formatDuration(data.p99);
    const p99_9 = formatDuration(data.p99_9);
    const avg = formatDuration(data.avg);

    console.log(`‚îÇ ${target.padEnd(11)} ‚îÇ ${p50.padStart(8)} ‚îÇ ${p75.padStart(8)} ‚îÇ ${p90.padStart(8)} ‚îÇ ${p95.padStart(8)} ‚îÇ ${p99.padStart(8)} ‚îÇ ${p99_9.padStart(8)} ‚îÇ ${avg.padStart(8)} ‚îÇ`);
  }

  console.log('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò');

  // Table 2: Min/Max and Throughput
  console.log('\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');
  console.log('‚îÇ Target      ‚îÇ Min      ‚îÇ Max      ‚îÇ Median   ‚îÇ Total    ‚îÇ RPS      ‚îÇ Errors   ‚îÇ');
  console.log('‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§');

  for (const target of TARGETS) {
    const data = results[target];
    if (!data) {
      console.log(`‚îÇ ${target.padEnd(11)} ‚îÇ N/A      ‚îÇ N/A      ‚îÇ N/A      ‚îÇ N/A      ‚îÇ N/A      ‚îÇ N/A      ‚îÇ`);
      continue;
    }

    const min = formatDuration(data.min);
    const max = formatDuration(data.max);
    const med = formatDuration(data.med);
    const total = formatNumber(data.totalRequests, 0);
    const rps = formatNumber(data.rps, 1);
    const errors = formatNumber(data.errors, 0);

    console.log(`‚îÇ ${target.padEnd(11)} ‚îÇ ${min.padStart(8)} ‚îÇ ${max.padStart(8)} ‚îÇ ${med.padStart(8)} ‚îÇ ${total.padStart(8)} ‚îÇ ${rps.padStart(8)} ‚îÇ ${errors.padStart(8)} ‚îÇ`);
  }

  console.log('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò');

  // Table 3: Error Rate
  console.log('\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');
  console.log('‚îÇ Target      ‚îÇ Error %  ‚îÇ');
  console.log('‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§');

  for (const target of TARGETS) {
    const data = results[target];
    if (!data) {
      console.log(`‚îÇ ${target.padEnd(11)} ‚îÇ N/A      ‚îÇ`);
      continue;
    }

    const errorRate = formatNumber(data.errorRate * 100, 3);

    console.log(`‚îÇ ${target.padEnd(11)} ‚îÇ ${errorRate.padStart(7)}% ‚îÇ`);
  }

  console.log('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò');

  // Legend explaining metrics
  console.log('\nüìñ Legend:');
  console.log('\n   Percentiles (Response Time):');
  console.log('   ‚Ä¢ p50 (50th percentile): Median - 50% of requests completed faster');
  console.log('   ‚Ä¢ p75 (75th percentile): 75% of requests completed within this time');
  console.log('   ‚Ä¢ p90 (90th percentile): 90% of requests completed within this time');
  console.log('   ‚Ä¢ p95 (95th percentile): 95% of requests completed within this time (common SLA target)');
  console.log('   ‚Ä¢ p99 (99th percentile): 99% of requests completed within this time (tail latency)');
  console.log('   ‚Ä¢ p99.9 (99.9th percentile): 99.9% of requests completed within this time (extreme tail)');
  console.log('\n   Basic Statistics:');
  console.log('   ‚Ä¢ Min: Fastest response time observed');
  console.log('   ‚Ä¢ Max: Slowest response time observed');
  console.log('   ‚Ä¢ Avg: Average response time across all requests');
  console.log('   ‚Ä¢ Median: Same as p50 - middle value when sorted');
  console.log('\n   Throughput & Errors:');
  console.log('   ‚Ä¢ Total: Total number of requests sent');
  console.log('   ‚Ä¢ RPS: Requests per second - throughput metric (higher is better)');
  console.log('   ‚Ä¢ Errors: Total number of failed requests');
  console.log('   ‚Ä¢ Error %: Percentage of requests that failed (lower is better)\n');

  // Quick analysis
  console.log('üìà Analysis:');
  
  const validResults = Object.entries(results).filter(([_, data]) => data);
  
  if (validResults.length > 1) {
    // Best p50 (median)
    const bestP50 = validResults.reduce((best, [target, data]) => {
      return !best || data.p50 < best.p50 ? { target, ...data } : best;
    }, null);
    if (bestP50) {
      console.log(`   üèÜ Best p50 (median): ${bestP50.target} (${formatDuration(bestP50.p50)})`);
    }

    // Best p95
    const bestP95 = validResults.reduce((best, [target, data]) => {
      return !best || data.p95 < best.p95 ? { target, ...data } : best;
    }, null);
    if (bestP95) {
      console.log(`   üèÜ Best p95: ${bestP95.target} (${formatDuration(bestP95.p95)})`);
    }

    // Best p99
    const bestP99 = validResults.reduce((best, [target, data]) => {
      return !best || data.p99 < best.p99 ? { target, ...data } : best;
    }, null);
    if (bestP99) {
      console.log(`   üèÜ Best p99 (tail latency): ${bestP99.target} (${formatDuration(bestP99.p99)})`);
    }

    // Best average
    const bestAvg = validResults.reduce((best, [target, data]) => {
      return !best || data.avg < best.avg ? { target, ...data } : best;
    }, null);
    if (bestAvg) {
      console.log(`   üìä Best average: ${bestAvg.target} (${formatDuration(bestAvg.avg)})`);
    }

    // Best RPS
    const bestRPS = validResults.reduce((best, [target, data]) => {
      return !best || data.rps > best.rps ? { target, ...data } : best;
    }, null);
    if (bestRPS) {
      console.log(`   üöÄ Highest RPS: ${bestRPS.target} (${formatNumber(bestRPS.rps, 1)} req/s)`);
    }

    // Lowest error rate
    const bestErrorRate = validResults.reduce((best, [target, data]) => {
      return !best || data.errorRate < best.errorRate ? { target, ...data } : best;
    }, null);
    if (bestErrorRate) {
      const errorRateStr = bestErrorRate.errorRate > 0 
        ? `${formatNumber(bestErrorRate.errorRate * 100, 3)}%`
        : '0%';
      console.log(`   ‚úÖ Lowest error rate: ${bestErrorRate.target} (${errorRateStr})`);
    }

    // Best min (fastest single request)
    const bestMin = validResults.reduce((best, [target, data]) => {
      return !best || data.min < best.min ? { target, ...data } : best;
    }, null);
    if (bestMin && bestMin.min > 0) {
      console.log(`   ‚ö° Fastest single request: ${bestMin.target} (${formatDuration(bestMin.min)})`);
    }
  }

  console.log('');
}

async function main() {
  const scenarioArg = process.argv.find(arg => arg.startsWith('--scenario='));
  const scenarioName = scenarioArg ? scenarioArg.split('=')[1] : 'all';

  console.log('\nüîç Analyzing load test results...');
  console.log('üíæ Using streaming processing (memory efficient)\n');

  if (!fs.existsSync(RESULTS_DIR)) {
    console.error(`‚ùå Results directory not found: ${RESULTS_DIR}`);
    console.error('   Run tests first with: npm run <scenario>');
    process.exit(1);
  }

  const scenariosToCompare = scenarioName === 'all' 
    ? SCENARIOS 
    : [scenarioName].filter(s => SCENARIOS.includes(s));

  if (scenariosToCompare.length === 0) {
    console.error(`‚ùå Invalid scenario: ${scenarioName}`);
    console.error(`Available scenarios: all, ${SCENARIOS.join(', ')}`);
    process.exit(1);
  }

  for (const scenario of scenariosToCompare) {
    process.stdout.write(`üìä Processing ${scenario}... `);
    const results = await findLatestResults(scenario);
    process.stdout.write('‚úÖ\n');
    printComparisonTable(scenario, results);
  }

  console.log(`\nüí° Tip: For more detailed analysis, use: npm run export-csv`);
  console.log(`   Or use tools like Grafana k6 Cloud for advanced visualization\n`);
}

main().catch(error => {
  console.error('‚ùå Error:', error.message);
  process.exit(1);
});

